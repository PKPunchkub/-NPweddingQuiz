<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namkhing & Punch Wedding Games - à¹€à¸à¸¡à¸—à¸²à¸¢à¹ƒà¸ˆà¸„à¸¹à¹ˆà¸šà¹ˆà¸²à¸§à¸ªà¸²à¸§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        
        .answer-btn {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        .answer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .correct-answer {
            animation: correctPulse 0.6s ease-in-out;
        }
        
        .wrong-answer {
            animation: wrongShake 0.6s ease-in-out;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .progress-bar {
            transition: width 1s linear;
        }
        
        .player-card {
            transition: all 0.3s ease;
        }
        
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .floating-hearts {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .heart {
            position: absolute;
            color: #ff69b4;
            font-size: 20px;
            animation: float 6s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-400 via-purple-500 to-indigo-600 min-h-screen relative">
    <!-- Floating Hearts Background -->
    <div class="floating-hearts" id="heartsContainer"></div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸«à¸¥à¸±à¸ (à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”) -->
    <div id="homeScreen" class="flex items-center justify-center min-h-screen p-4">
        <div class="text-center bg-white rounded-3xl p-8 shadow-2xl max-w-md mx-4">
            <div class="text-6xl mb-4">ğŸ’•</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Namkhing & Punch Wedding Games</h1>
            <p class="text-lg text-pink-600 font-semibold mb-6">à¹€à¸à¸¡à¸—à¸²à¸¢à¹ƒà¸ˆà¸„à¸¹à¹ˆà¸šà¹ˆà¸²à¸§à¸ªà¸²à¸§ (Guess the Couple's Mind Game)</p>
            
            <!-- à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ -->
            <div class="bg-blue-50 p-4 rounded-xl mb-6 border-2 border-blue-200">
                <h3 class="text-sm font-bold text-blue-800 mb-2">ğŸ“‹ à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ (How to Use)</h3>
                <div class="text-xs text-blue-700 space-y-1">
                    <p>ğŸ’» <strong>Host:</strong> à¹ƒà¸Šà¹‰à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸à¸¡</p>
                    <p>ğŸ“± <strong>à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™:</strong> à¹ƒà¸Šà¹‰à¸¡à¸·à¸­à¸–à¸·à¸­à¸ªà¹à¸à¸™ QR Code</p>
                    <p>ğŸ® à¹€à¸¥à¹ˆà¸™à¹„à¸”à¹‰à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 250 à¸„à¸™</p>
                </div>
            </div>
            
            <div class="space-y-4">
                <button onclick="showHostScreen()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    ğŸ¯ à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸ à¸²à¸ (Host - Create QR Code)
                </button>
                
                <button onclick="showRegisterScreen()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-pink-600 hover:to-purple-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    ğŸ‘¥ à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¹€à¸à¸¡ (Join Game)
                </button>
            </div>
            
            <div class="mt-6 text-sm text-gray-600">
                <p>à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ (Online Players): <span id="onlineCount" class="font-bold text-pink-600">0</span> à¸„à¸™</p>
            </div>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ Admin -->
    <div id="passwordScreen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="text-center bg-white rounded-3xl p-8 shadow-2xl max-w-md mx-4">
            <div class="text-6xl mb-4">ğŸ”</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™ Admin (Admin Verification)</h1>
            <p class="text-lg text-purple-600 font-semibold mb-8">à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹€à¸à¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¹‚à¸«à¸¡à¸”à¹€à¸ˆà¹‰à¸²à¸ à¸²à¸ (Please enter password to access host mode)</p>
            
            <div class="mb-6">
                <input type="password" id="adminPassword" placeholder="à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ Admin (Admin Password)" 
                       class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none text-center"
                       onkeypress="if(event.key==='Enter') verifyPassword()">
            </div>
            
            <div class="space-y-4">
                <button onclick="verifyPassword()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    ğŸ”“ à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (Verify Password)
                </button>
                
                <button onclick="showHomeScreen()" class="bg-gray-500 text-white px-6 py-3 rounded-full text-lg font-semibold hover:bg-gray-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    â† à¸à¸¥à¸±à¸š (Back)
                </button>
            </div>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹€à¸ˆà¹‰à¸²à¸ à¸²à¸ (à¸ªà¸£à¹‰à¸²à¸‡ QR Code) -->
    <div id="hostScreen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="text-center bg-white rounded-3xl p-8 shadow-2xl max-w-lg mx-4">
            <div class="text-4xl mb-4">ğŸ¯</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Host Control Panel</h2>
            <p class="text-lg text-purple-600 font-semibold mb-6">à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸à¸¡à¸ˆà¸²à¸à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œ (Control game from computer)</p>
            
            <!-- à¸ªà¸–à¸²à¸™à¸°à¸«à¹‰à¸­à¸‡ -->
            <div class="bg-purple-100 p-4 rounded-xl mb-6 border-2 border-purple-300">
                <h3 class="text-lg font-bold text-purple-800 mb-2">ğŸ  à¸ªà¸–à¸²à¸™à¸°à¸«à¹‰à¸­à¸‡à¹€à¸¥à¹ˆà¸™ (Room Status)</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded-lg">
                        <p class="text-gray-600">Room ID</p>
                        <p id="hostRoomDisplay" class="font-bold text-purple-600">-</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <p class="text-gray-600">à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ</p>
                        <p class="font-bold text-green-600"><span id="hostOnlineCount">0</span> à¸„à¸™</p>
                    </div>
                </div>
                <div class="mt-3 text-xs text-purple-600">
                    <p>âœ… à¸«à¹‰à¸­à¸‡à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ - à¹ƒà¸«à¹‰à¹à¸‚à¸à¸ªà¹à¸à¸™ QR Code à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡</p>
                    <p>ğŸ“± à¹à¸‚à¸à¹ƒà¸Šà¹‰à¸¡à¸·à¸­à¸–à¸·à¸­à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ | ğŸ’» Host à¹ƒà¸Šà¹‰à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™</p>
                </div>
            </div>
            
            <!-- QR Code -->
            <div class="bg-gray-50 p-6 rounded-2xl mb-6">
                <div id="qrcode" class="flex justify-center mb-4"></div>
                <p class="text-sm text-gray-600 mb-4">ğŸ“± à¹ƒà¸«à¹‰à¹à¸‚à¸à¸ªà¹à¸à¸™ QR Code à¸™à¸µà¹‰à¸”à¹‰à¸§à¸¢à¸¡à¸·à¸­à¸–à¸·à¸­à¹€à¸à¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¹€à¸à¸¡<br>(Let guests scan this QR Code with mobile phone to join)</p>
                
                <!-- à¸¥à¸´à¸‡à¸à¹Œà¹à¸Šà¸£à¹Œ -->
                <div class="bg-white p-4 rounded-xl border-2 border-dashed border-gray-300">
                    <p class="text-xs text-gray-500 mb-2">à¸«à¸£à¸·à¸­à¹à¸Šà¸£à¹Œà¸¥à¸´à¸‡à¸à¹Œà¸™à¸µà¹‰ (Or share this link):</p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="shareLink" readonly 
                               class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50">
                        <button onclick="copyLink()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                            ğŸ“‹ à¸„à¸±à¸”à¸¥à¸­à¸ (Copy)
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <button onclick="showWaitingScreenAsHost()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-green-600 hover:to-blue-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    ğŸ“Š à¸”à¸¹à¸«à¹‰à¸­à¸‡à¸£à¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ (View Waiting Room)
                </button>
                
                <button onclick="debugGameState()" class="bg-red-500 text-white px-6 py-3 rounded-full text-lg font-semibold hover:bg-red-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    ğŸ” Debug Info
                </button>
                
                <button onclick="showHomeScreen()" class="bg-gray-500 text-white px-6 py-3 rounded-full text-lg font-semibold hover:bg-gray-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    â† à¸à¸¥à¸±à¸š (Back)
                </button>
            </div>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ -->
    <div id="registerScreen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="text-center bg-white rounded-3xl p-8 shadow-2xl max-w-md mx-4">
            <div class="text-6xl mb-4">ğŸ’•</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¹€à¸à¸¡ (Join Game)</h1>
            <p class="text-lg text-pink-600 font-semibold mb-6">à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡à¸„à¸¸à¸“ (Fill in your information)</p>
            
            <div class="mb-6">
                <input type="text" id="playerName" placeholder="à¸Šà¸·à¹ˆà¸­à¸‚à¸­à¸‡à¸„à¸¸à¸“ (Your Name)" 
                       class="w-full px-4 py-3 border-2 border-pink-300 rounded-xl text-lg focus:border-pink-500 focus:outline-none mb-4">
                <input type="text" id="playerTable" placeholder="à¹‚à¸•à¹Šà¸°à¸—à¸µà¹ˆ (Table Number - Optional)" 
                       class="w-full px-4 py-3 border-2 border-pink-300 rounded-xl text-lg focus:border-pink-500 focus:outline-none">
            </div>
            
            <div class="space-y-4">
                <button onclick="registerPlayer()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-pink-600 hover:to-purple-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¹€à¸à¸¡ (Join Game) ğŸ’–
                </button>
                
                <button onclick="showHomeScreen()" class="bg-gray-500 text-white px-6 py-3 rounded-full text-lg font-semibold hover:bg-gray-600 transform hover:scale-105 transition-all duration-300 shadow-lg w-full">
                    â† à¸à¸¥à¸±à¸š (Back)
                </button>
            </div>
            
            <div class="mt-6 text-sm text-gray-600">
                <p>à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ: <span id="onlineCountRegister" class="font-bold text-pink-600">0</span> à¸„à¸™</p>
            </div>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ -->
    <div id="waitingScreen" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">ğŸ‰ à¸«à¹‰à¸­à¸‡à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (Waiting Room) ğŸ‰</h1>
                <div class="bg-white rounded-full px-6 py-3 inline-block shadow-lg mb-4">
                    <span class="text-xl font-semibold">à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (Total Players): <span id="totalPlayers" class="text-pink-600">0</span> à¸„à¸™</span>
                </div>
                <div id="roomInfoWaiting" class="bg-white bg-opacity-20 rounded-full px-4 py-2 inline-block">
                    <span class="text-white text-sm">ğŸ  à¸«à¹‰à¸­à¸‡à¹€à¸¥à¹ˆà¸™: <span id="waitingRoomId">-</span></span>
                </div>
            </div>

            <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ -->
            <div class="bg-white rounded-3xl p-6 mb-8 shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-4">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡à¸„à¸¸à¸“ (Your Information)</h3>
                <div class="text-center">
                    <div id="playerCharacter" class="text-6xl mb-4"></div>
                    <p class="text-xl">à¸ªà¸§à¸±à¸ªà¸”à¸µ (Hello) <span id="welcomeName" class="font-bold text-pink-600"></span>!</p>
                    <p id="welcomeTable" class="text-gray-600"></p>
                    <p class="text-sm text-gray-500 mt-2">à¸£à¸­à¹€à¸ˆà¹‰à¸²à¸šà¹ˆà¸²à¸§à¹€à¸ˆà¹‰à¸²à¸ªà¸²à¸§à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡à¸™à¸°à¸„à¸°... (Waiting for the bride and groom to start the game...)</p>
                </div>
            </div>

            <!-- à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ -->
            <div class="bg-white rounded-3xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold text-center mb-4">à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡ (Joined Players)</h3>
                <div id="playersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                    <!-- à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ -->
                </div>
            </div>

            <!-- à¸›à¸¸à¹ˆà¸¡à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (à¸ªà¸³à¸«à¸£à¸±à¸š Admin à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™) -->
            <div class="text-center mt-8 space-y-4">
                <div class="flex justify-center">
                    <button id="startGameBtn" onclick="startGame()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-12 py-4 rounded-full text-xl font-semibold hover:from-green-600 hover:to-blue-600 transform hover:scale-105 transition-all duration-300 shadow-lg" style="display: none;">
                        ğŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (Start Game)
                    </button>
                </div>
                
                <div id="waitingMessage" class="bg-white rounded-full px-8 py-4 inline-block shadow-lg">
                    <p class="text-lg text-gray-700">â³ à¸£à¸­ Admin à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡... (Waiting for Admin to start the game...)</p>
                </div>
                
                <button onclick="goBackFromWaiting()" class="bg-gray-500 text-white px-8 py-3 rounded-full text-lg font-semibold hover:bg-gray-600 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    â† à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š (Back)
                </button>
            </div>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹€à¸à¸¡ -->
    <div id="gameScreen" class="hidden min-h-screen p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
            <div class="bg-white rounded-full px-6 py-3 shadow-lg">
                <span class="text-lg font-semibold">à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ (Question) <span id="questionNumber">1</span>/5</span>
            </div>
            <div class="bg-white rounded-full px-6 py-3 shadow-lg flex items-center">
                <span id="gamePlayerCharacter" class="text-2xl mr-2">ğŸ¶</span>
                <span class="text-lg font-semibold">à¸„à¸°à¹à¸™à¸™ (Score): <span id="score">0</span></span>
            </div>
            <div class="bg-white rounded-full px-6 py-3 shadow-lg">
                <span class="text-lg font-semibold">à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ (Players): <span id="gamePlayerCount">0</span> à¸„à¸™</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="bg-white rounded-full h-3 mb-8 shadow-inner">
            <div id="progressBar" class="progress-bar bg-gradient-to-r from-pink-400 to-purple-500 h-full rounded-full" style="width: 0%"></div>
        </div>

        <!-- Timer -->
        <div class="text-center mb-6">
            <div id="timer" class="text-6xl font-bold text-white drop-shadow-lg">10</div>
            <p class="text-white text-xl">à¸§à¸´à¸™à¸²à¸—à¸µ (seconds)</p>
        </div>

        <!-- à¸„à¸³à¸–à¸²à¸¡ -->
        <div class="bg-white rounded-3xl p-8 mb-8 shadow-2xl text-center">
            <h2 id="questionText" class="text-2xl md:text-3xl font-bold text-gray-800 mb-4"></h2>
        </div>

        <!-- à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸„à¸³à¸•à¸­à¸š -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto">
            <button id="answer0" class="answer-btn bg-red-500 hover:bg-red-600 text-white p-6 rounded-2xl text-xl font-semibold shadow-lg" onclick="selectAnswer(0)">
                <div class="flex items-center justify-center">
                    <span class="mr-3">ğŸ”º</span>
                    <span id="answerText0"></span>
                </div>
            </button>
            <button id="answer1" class="answer-btn bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-2xl text-xl font-semibold shadow-lg" onclick="selectAnswer(1)">
                <div class="flex items-center justify-center">
                    <span class="mr-3">ğŸ’</span>
                    <span id="answerText1"></span>
                </div>
            </button>
            <button id="answer2" class="answer-btn bg-yellow-500 hover:bg-yellow-600 text-white p-6 rounded-2xl text-xl font-semibold shadow-lg" onclick="selectAnswer(2)">
                <div class="flex items-center justify-center">
                    <span class="mr-3">â­•</span>
                    <span id="answerText2"></span>
                </div>
            </button>
            <button id="answer3" class="answer-btn bg-green-500 hover:bg-green-600 text-white p-6 rounded-2xl text-xl font-semibold shadow-lg" onclick="selectAnswer(3)">
                <div class="flex items-center justify-center">
                    <span class="mr-3">â¬œ</span>
                    <span id="answerText3"></span>
                </div>
            </button>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­ Host Dashboard -->
    <div id="hostDashboard" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">ğŸ¯ Host Dashboard - à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸à¸¡</h1>
                <div class="bg-white rounded-full px-6 py-3 inline-block shadow-lg mb-4">
                    <span class="text-xl font-semibold">à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ (Question): <span id="hostQuestionNumber">1</span>/5</span>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full px-4 py-2 inline-block">
                    <span class="text-white text-sm">ğŸ  à¸«à¹‰à¸­à¸‡à¹€à¸¥à¹ˆà¸™: <span id="hostRoomId">-</span> | à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™: <span id="hostPlayerCount">0</span> à¸„à¸™</span>
                </div>
            </div>

            <!-- à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ -->
            <div class="bg-white rounded-3xl p-8 mb-8 shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-4">à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (Current Question)</h3>
                <div class="text-center mb-6">
                    <div id="hostTimer" class="text-6xl font-bold text-purple-600 mb-2">10</div>
                    <p class="text-gray-600 text-xl">à¸§à¸´à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­ (Seconds remaining)</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl mb-6">
                    <h4 id="hostQuestionText" class="text-xl font-semibold text-gray-800 mb-4"></h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-red-100 p-4 rounded-xl">
                            <span class="text-red-600 font-semibold">ğŸ”º A:</span>
                            <span id="hostAnswer0" class="ml-2"></span>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-xl">
                            <span class="text-blue-600 font-semibold">ğŸ’ B:</span>
                            <span id="hostAnswer1" class="ml-2"></span>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-xl">
                            <span class="text-yellow-600 font-semibold">â­• C:</span>
                            <span id="hostAnswer2" class="ml-2"></span>
                        </div>
                        <div class="bg-green-100 p-4 rounded-xl" id="hostCorrectAnswer">
                            <span class="text-green-600 font-semibold">â¬œ D:</span>
                            <span id="hostAnswer3" class="ml-2"></span>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡: <span id="hostCorrectText" class="font-bold text-green-600"></span></p>
                    </div>
                </div>
            </div>

            <!-- à¸ªà¸–à¸´à¸•à¸´à¸à¸²à¸£à¸•à¸­à¸š Real-time -->
            <div class="bg-white rounded-3xl p-8 mb-8 shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-6">ğŸ“Š à¸ªà¸–à¸´à¸•à¸´à¸à¸²à¸£à¸•à¸­à¸š Real-time</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-red-100 p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-red-600" id="answerStatsA">0</div>
                        <div class="text-sm text-red-600">à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ A</div>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-blue-600" id="answerStatsB">0</div>
                        <div class="text-sm text-blue-600">à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ B</div>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="answerStatsC">0</div>
                        <div class="text-sm text-yellow-600">à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ C</div>
                    </div>
                    <div class="bg-green-100 p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-green-600" id="answerStatsD">0</div>
                        <div class="text-sm text-green-600">à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ D</div>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-lg">à¸•à¸­à¸šà¹à¸¥à¹‰à¸§: <span id="answeredCount" class="font-bold text-purple-600">0</span> / <span id="totalPlayersCount">0</span> à¸„à¸™</p>
                </div>
            </div>

            <!-- Scoreboard -->
            <div class="bg-white rounded-3xl p-8 shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-6">ğŸ† Scoreboard à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™</h3>
                <div id="hostLeaderboard" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Scoreboard à¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ -->
                </div>
            </div>

            <!-- à¸›à¸¸à¹ˆà¸¡à¸„à¸§à¸šà¸„à¸¸à¸¡ -->
            <div class="text-center mt-8 space-y-4">
                <button onclick="hostEndGame()" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-red-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    ğŸ à¸ˆà¸šà¹€à¸à¸¡ (End Game)
                </button>
                
                <button onclick="showHostScreen()" class="bg-gray-500 text-white px-8 py-3 rounded-full text-lg font-semibold hover:bg-gray-600 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    â† à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¹€à¸ˆà¹‰à¸²à¸ à¸²à¸ (Back to Host)
                </button>
            </div>
        </div>
    </div>

    <!-- à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ -->
    <div id="resultScreen" class="hidden min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <div id="resultEmoji" class="text-8xl mb-6">ğŸ†</div>
                <h2 class="text-4xl font-bold text-white mb-4">ğŸ‰ à¸œà¸¥à¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™ (Results) ğŸ‰</h2>
            </div>

            <!-- à¸„à¸°à¹à¸™à¸™à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ (à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™) -->
            <div id="playerScoreSection" class="bg-white rounded-3xl p-8 mb-8 shadow-2xl text-center">
                <h3 class="text-2xl font-bold mb-4">à¸„à¸°à¹à¸™à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“ (Your Score)</h3>
                <p class="text-5xl font-bold text-pink-600 mb-2"><span id="finalScore">0</span>/5</p>
                <p id="playerRank" class="text-xl text-gray-600"></p>
            </div>

            <!-- à¸­à¸±à¸™à¸”à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ -->
            <div class="bg-white rounded-3xl p-8 shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-6">ğŸ† à¸­à¸±à¸™à¸”à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ Top 10 (Top 10 Leaderboard)</h3>
                <div id="leaderboard" class="space-y-3">
                    <!-- à¸­à¸±à¸™à¸”à¸±à¸šà¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ -->
                </div>
            </div>

            <div class="text-center mt-8">
                <button onclick="restartGame()" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-semibold hover:from-pink-600 hover:to-purple-600 transform hover:scale-105 transition-all duration-300 shadow-lg">
                    à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ (Play Again) ğŸ”„
                </button>
            </div>
        </div>
    </div>

    <script>
        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸„à¸¹à¹ˆà¸šà¹ˆà¸²à¸§à¸ªà¸²à¸§
        const questions = [
            {
                question: "à¹€à¸ˆà¹‰à¸²à¸šà¹ˆà¸²à¸§à¹€à¸ˆà¹‰à¸²à¸ªà¸²à¸§à¸à¸šà¸à¸±à¸™à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸à¸—à¸µà¹ˆà¹„à¸«à¸™? (Where did the bride and groom first meet?)",
                answers: ["à¸¡à¸«à¸²à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢ (University)", "à¸—à¸µà¹ˆà¸—à¸³à¸‡à¸²à¸™ (At work)", "à¸‡à¸²à¸™à¹€à¸à¸·à¹ˆà¸­à¸™ (Friend's party)", "à¹à¸­à¸›à¸«à¸²à¸„à¸¹à¹ˆ (Dating app)"],
                correct: 1
            },
            {
                question: "à¹€à¸ˆà¹‰à¸²à¸ªà¸²à¸§à¸Šà¸­à¸šà¸ªà¸µà¸­à¸°à¹„à¸£à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”? (What is the bride's favorite color?)",
                answers: ["à¸Šà¸¡à¸à¸¹ (Pink)", "à¸Ÿà¹‰à¸² (Blue)", "à¹€à¸‚à¸µà¸¢à¸§ (Green)", "à¸¡à¹ˆà¸§à¸‡ (Purple)"],
                correct: 0
            },
            {
                question: "à¹€à¸ˆà¹‰à¸²à¸šà¹ˆà¸²à¸§à¸‚à¸­à¹à¸•à¹ˆà¸‡à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹„à¸«à¸™? (Where did the groom propose?)",
                answers: ["à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£ (Restaurant)", "à¸Šà¸²à¸¢à¸«à¸²à¸” (Beach)", "à¸šà¹‰à¸²à¸™ (Home)", "à¸ªà¸§à¸™à¸ªà¸²à¸˜à¸²à¸£à¸“à¸° (Park)"],
                correct: 1
            },
            {
                question: "à¸„à¸¹à¹ˆà¸šà¹ˆà¸²à¸§à¸ªà¸²à¸§à¸Šà¸­à¸šà¸—à¸³à¸­à¸°à¹„à¸£à¸£à¹ˆà¸§à¸¡à¸à¸±à¸™à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”? (What do the couple enjoy doing together most?)",
                answers: ["à¸”à¸¹à¸«à¸™à¸±à¸‡ (Watching movies)", "à¸—à¸³à¸­à¸²à¸«à¸²à¸£ (Cooking)", "à¹€à¸—à¸µà¹ˆà¸¢à¸§ (Traveling)", "à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡ (Playing games)"],
                correct: 2
            },
            {
                question: "à¹€à¸ˆà¹‰à¸²à¸šà¹ˆà¸²à¸§à¹€à¸ˆà¹‰à¸²à¸ªà¸²à¸§à¸¡à¸µà¸„à¸§à¸²à¸¡à¸à¸±à¸™à¸£à¹ˆà¸§à¸¡à¸à¸±à¸™à¸„à¸·à¸­à¸­à¸°à¹„à¸£? (What is the couple's shared dream?)",
                answers: ["à¹€à¸›à¸´à¸”à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£ (Open a restaurant)", "à¹€à¸—à¸µà¹ˆà¸¢à¸§à¸£à¸­à¸šà¹‚à¸¥à¸ (Travel around the world)", "à¸¡à¸µà¸šà¹‰à¸²à¸™à¸«à¸¥à¸±à¸‡à¹ƒà¸«à¸à¹ˆ (Have a big house)", "à¹€à¸¥à¸µà¹‰à¸¢à¸‡à¸ªà¸¸à¸™à¸±à¸‚ (Raise dogs)"],
                correct: 1
            }
        ];

        // à¸•à¸±à¸§à¹à¸›à¸£à¹€à¸à¸¡
        let players = [];
        let currentPlayer = null;
        let currentQuestion = 0;
        let score = 0;
        let timeLeft = 10;
        let timer;
        let gameActive = false;
        let gameStarted = false;
        let isHost = false;
        let gameState = 'waiting';
        let syncInterval;
        let roomId = null;
        let gameSession = null;
        let questionStartTime = null;
        let gameTimer = null;

        // Character à¸ªà¸±à¸•à¸§à¹Œà¸à¸²à¸£à¹Œà¸•à¸¹à¸™ 250 à¹à¸šà¸š
        const animalCharacters = [
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦', 'ğŸ¯', 'ğŸ¸', 'ğŸ·', 'ğŸ®', 'ğŸµ',
            'ğŸ¦„', 'ğŸ´', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸº', 'ğŸ—', 'ğŸ½', 'ğŸ„', 'ğŸ‚', 'ğŸƒ', 'ğŸª', 'ğŸ«', 'ğŸ¦', 'ğŸ¦›', 'ğŸ˜',
            'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ¾', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦',
            'ğŸ™', 'ğŸ¦‘', 'ğŸ ', 'ğŸŸ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ³', 'ğŸ‹', 'ğŸ¦­', 'ğŸ§', 'ğŸ¦', 'ğŸ¦€', 'ğŸš', 'ğŸª¸', 'ğŸŒ',
            'ğŸ¦', 'ğŸ¦ª', 'ğŸ¢', 'ğŸŠ', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ²', 'ğŸ‰', 'ğŸ¦', 'ğŸ', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ•·ï¸', 'ğŸ¦Ÿ', 'ğŸ¦ ',
            'ğŸ¦', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¥', 'ğŸ¤', 'ğŸ£', 'ğŸ¦©', 'ğŸ•Šï¸', 'ğŸ¦¤',
            'ğŸª¶', 'ğŸ¦‹', 'ğŸ›', 'ğŸ', 'ğŸ', 'ğŸ¦—', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ•·ï¸', 'ğŸ¦Ÿ', 'ğŸ¦ ', 'ğŸœ', 'ğŸª²', 'ğŸª³', 'ğŸ¦ª',
            'ğŸ¦„', 'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ¦£', 'ğŸ¦', 'ğŸ¦›', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ¦”',
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦', 'ğŸ¯', 'ğŸ¸', 'ğŸ·', 'ğŸ®', 'ğŸµ',
            'ğŸ¦„', 'ğŸ´', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸº', 'ğŸ—', 'ğŸ½', 'ğŸ„', 'ğŸ‚', 'ğŸƒ', 'ğŸª', 'ğŸ«', 'ğŸ¦', 'ğŸ¦›', 'ğŸ˜',
            'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ¾', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦',
            'ğŸ™', 'ğŸ¦‘', 'ğŸ ', 'ğŸŸ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ³', 'ğŸ‹', 'ğŸ¦­', 'ğŸ§', 'ğŸ¦', 'ğŸ¦€', 'ğŸš', 'ğŸª¸', 'ğŸŒ',
            'ğŸ¦', 'ğŸ¦ª', 'ğŸ¢', 'ğŸŠ', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ²', 'ğŸ‰', 'ğŸ¦', 'ğŸ', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ•·ï¸', 'ğŸ¦Ÿ', 'ğŸ¦ ',
            'ğŸ¦', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¥', 'ğŸ¤', 'ğŸ£', 'ğŸ¦©', 'ğŸ•Šï¸', 'ğŸ¦¤',
            'ğŸª¶', 'ğŸ¦‹', 'ğŸ›', 'ğŸ', 'ğŸ', 'ğŸ¦—', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ•·ï¸', 'ğŸ¦Ÿ', 'ğŸ¦ ', 'ğŸœ', 'ğŸª²', 'ğŸª³', 'ğŸ¦ª',
            'ğŸ¦„', 'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ¦£', 'ğŸ¦', 'ğŸ¦›', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ¦”',
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦'
        ];

        // à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸„à¸£à¸š 250 à¸•à¸±à¸§
        while (animalCharacters.length < 250) {
            const baseAnimals = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦'];
            animalCharacters.push(...baseAnimals.slice(0, Math.min(baseAnimals.length, 250 - animalCharacters.length)));
        }

        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸¸à¹ˆà¸¡à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸‹à¹‰à¸³
        function getUniqueAnimalCharacter() {
            const usedCharacters = players.map(player => player.character).filter(char => char);
            const availableCharacters = animalCharacters.filter(char => !usedCharacters.includes(char));
            
            if (availableCharacters.length === 0) {
                return animalCharacters[Math.floor(Math.random() * animalCharacters.length)];
            }
            
            return availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
        }

        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸—à¸µà¹ˆà¸«à¸²à¸¢à¹„à¸›
        function ensurePlayerCharacter(player) {
            if (!player.character || player.character === '' || player.character === null || player.character === undefined) {
                player.character = getUniqueAnimalCharacter();
            }
            return player.character;
        }

        // à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ - à¸ˆà¸³à¸à¸±à¸”à¹€à¸à¸µà¸¢à¸‡ 1 à¸«à¹‰à¸­à¸‡
        function createNewGameRoom() {
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
            const existingRoomId = localStorage.getItem('activeRoomId');
            if (existingRoomId) {
                const existingRoom = localStorage.getItem('room-' + existingRoomId);
                if (existingRoom) {
                    try {
                        const roomData = JSON.parse(existingRoom);
                        // à¸–à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸¢à¸±à¸‡à¹ƒà¸«à¸¡à¹ˆ (à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 2 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡) à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸«à¹‰à¸­à¸‡à¹€à¸”à¸´à¸¡
                        if (Date.now() - roomData.timestamp < 7200000) {
                            roomId = existingRoomId;
                            console.log('Using existing room:', roomId);
                            return roomId;
                        }
                    } catch (e) {
                        console.log('Error parsing existing room data');
                    }
                }
            }
            
            // à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¹à¸¥à¸°à¸¥à¸šà¸«à¹‰à¸­à¸‡à¹€à¸à¹ˆà¸²
            clearOldRooms();
            
            roomId = 'WEDDING-GAME-' + Date.now().toString().slice(-8);
            gameSession = {
                roomId: roomId,
                createdAt: Date.now(),
                hostId: 'host-' + Date.now(),
                gameState: 'waiting',
                gameStarted: false,
                currentQuestion: 0,
                players: [],
                isActive: true
            };
            
            localStorage.setItem('currentGameSession', JSON.stringify(gameSession));
            localStorage.setItem('activeRoomId', roomId);
            localStorage.setItem('room-' + roomId, JSON.stringify({
                roomId: roomId,
                players: [],
                gameState: 'waiting',
                gameStarted: false,
                currentQuestion: 0,
                timestamp: Date.now(),
                isActive: true
            }));
            
            console.log('Created new game room:', roomId);
            return roomId;
        }

        // à¸¥à¸šà¸«à¹‰à¸­à¸‡à¹€à¸à¹ˆà¸²à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§
        function clearOldRooms() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('room-')) {
                    try {
                        const roomData = JSON.parse(localStorage.getItem(key));
                        // à¸¥à¸šà¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¹€à¸à¹ˆà¸²à¸à¸§à¹ˆà¸² 2 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡
                        if (Date.now() - roomData.timestamp > 7200000) {
                            localStorage.removeItem(key);
                            console.log('Removed old room:', key);
                        }
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }
            });
        }

        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸‹à¸´à¸‡à¸„à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸¡ - à¹€à¸ªà¸–à¸µà¸¢à¸£à¸‚à¸¶à¹‰à¸™
        function syncGameData() {
            if (!roomId) {
                console.log('No room ID, creating new room');
                createNewGameRoom();
            }

            const gameData = {
                roomId: roomId,
                players: players,
                gameState: gameState,
                gameStarted: gameStarted,
                currentQuestion: currentQuestion,
                questionStartTime: questionStartTime,
                timeLeft: timeLeft,
                timestamp: Date.now()
            };
            
            // à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸šà¸šà¸‡à¹ˆà¸²à¸¢
            try {
                localStorage.setItem('room-' + roomId, JSON.stringify(gameData));
                localStorage.setItem('activeRoomId', roomId);
            } catch (error) {
                console.error('Error saving game data:', error);
            }
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¹€à¸‹à¸ªà¸Šà¸±à¸™à¹€à¸à¸¡
            if (gameSession) {
                gameSession.players = players;
                gameSession.gameState = gameState;
                gameSession.gameStarted = gameStarted;
                gameSession.currentQuestion = currentQuestion;
                gameSession.questionStartTime = questionStartTime;
                gameSession.lastUpdate = Date.now();
                localStorage.setItem('currentGameSession', JSON.stringify(gameSession));
            }
        }

        // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸¡à¸ˆà¸²à¸ localStorage - à¹€à¸ªà¸–à¸µà¸¢à¸£à¸‚à¸¶à¹‰à¸™
        function loadSharedGameData() {
            if (!roomId) return false;
            
            try {
                const data = localStorage.getItem('room-' + roomId);
                if (!data) return false;
                
                const gameData = JSON.parse(data);
                if (!gameData || !gameData.timestamp) return false;
                
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸²à¸¢à¸¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 30 à¸™à¸²à¸—à¸µ)
                const dataAge = Date.now() - gameData.timestamp;
                if (dataAge > 1800000) return false;
                
                // à¸­à¸±à¸à¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸¡
                const existingPlayerIds = players.map(p => p.id);
                const newPlayers = gameData.players || [];
                
                // à¹€à¸à¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ
                newPlayers.forEach(newPlayer => {
                    const existingIndex = players.findIndex(p => p.id === newPlayer.id);
                    if (existingIndex >= 0) {
                        // à¸­à¸±à¸à¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ
                        players[existingIndex] = { ...players[existingIndex], ...newPlayer };
                    } else {
                        // à¹€à¸à¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ
                        players.push(newPlayer);
                    }
                });
                
                gameState = gameData.gameState || 'waiting';
                gameStarted = gameData.gameStarted || false;
                currentQuestion = gameData.currentQuestion || 0;
                questionStartTime = gameData.questionStartTime || null;
                timeLeft = gameData.timeLeft || 10;
                
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
                players.forEach(player => {
                    ensurePlayerCharacter(player);
                });
                
                return true;
            } catch (error) {
                console.error('Error loading game data:', error);
                return false;
            }
        }

        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸°à¹€à¸à¸¡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ - Real-time à¸ªà¸³à¸«à¸£à¸±à¸š Host
        function startGameSync() {
            console.log('Starting game sync...');
            
            loadSharedGameData();
            updateOnlineCount();
            updatePlayersList();
            
            // Storage events - à¸•à¸­à¸šà¸ªà¸™à¸­à¸‡à¸—à¸±à¸™à¸—à¸µà¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡
            window.addEventListener('storage', function(e) {
                if (e.key && e.key.startsWith('room-')) {
                    const oldGameStarted = gameStarted;
                    const oldPlayersCount = players.length;
                    
                    loadSharedGameData();
                    updateOnlineCount();
                    updatePlayersList();
                    
                    // à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Host à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ
                    if (isHost && players.length > oldPlayersCount) {
                        console.log('New player joined! Total players:', players.length);
                        showPlayerJoinedNotification();
                    }
                    
                    if (!oldGameStarted && gameStarted && !isHost) {
                        handleGameStart();
                    }
                }
            });
            
            // Polling à¸ªà¸³à¸«à¸£à¸±à¸š Host à¸—à¸¸à¸ 1 à¸§à¸´à¸™à¸²à¸—à¸µ, à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸¸à¸ 2 à¸§à¸´à¸™à¸²à¸—à¸µ
            const pollInterval = isHost ? 1000 : 2000;
            syncInterval = setInterval(() => {
                const oldGameStarted = gameStarted;
                const oldCurrentQuestion = currentQuestion;
                const oldPlayersCount = players.length;
                
                loadSharedGameData();
                updateOnlineCount();
                updatePlayersList();
                
                // à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Host à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ
                if (isHost && players.length > oldPlayersCount) {
                    console.log('New player detected via polling! Total players:', players.length);
                    showPlayerJoinedNotification();
                }
                
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡
                if (!oldGameStarted && gameStarted && !isHost) {
                    handleGameStart();
                }
                
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸„à¸³à¸–à¸²à¸¡ (à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™)
                if (!isHost && gameStarted && oldCurrentQuestion !== currentQuestion) {
                    showQuestion();
                }
                
                // à¸­à¸±à¸à¹€à¸”à¸— Host Dashboard à¸–à¹‰à¸²à¹€à¸›à¸´à¸”à¸­à¸¢à¸¹à¹ˆ
                if (isHost && !document.getElementById('hostDashboard').classList.contains('hidden')) {
                    updateAnswerStats();
                    updateHostScoreboard();
                }
            }, pollInterval);
            
            // Visibility events
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    const oldGameStarted = gameStarted;
                    const oldGameState = gameState;
                    const oldPlayersCount = players.length;
                    
                    loadSharedGameData();
                    updateOnlineCount();
                    updatePlayersList();
                    
                    // à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Host à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ
                    if (isHost && players.length > oldPlayersCount) {
                        showPlayerJoinedNotification();
                    }
                    
                    if (!oldGameStarted && gameStarted && !isHost) {
                        handleGameStart();
                    }
                    
                    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸ˆà¸šà¹€à¸à¸¡
                    if (oldGameState !== 'finished' && gameState === 'finished' && !isHost) {
                        endGame();
                    }
                }
            });
            
            // à¸Ÿà¸±à¸‡à¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œà¸ˆà¸šà¹€à¸à¸¡à¸ˆà¸²à¸ Host
            window.addEventListener('gameEnded', function(e) {
                if (e.detail.roomId === roomId && !isHost) {
                    endGame();
                }
            });
            
            // BroadcastChannel à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¹à¸šà¸š Real-time
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('wedding-game-sync');
                channel.onmessage = function(event) {
                    const data = event.data;
                    if (data.roomId === roomId) {
                        if (data.type === 'playerJoined' && isHost) {
                            loadSharedGameData();
                            updateOnlineCount();
                            updatePlayersList();
                            showPlayerJoinedNotification(data.player);
                        } else if (data.type === 'gameStarted' && !isHost) {
                            handleGameStart();
                        } else if (data.type === 'gameEnded' && !isHost) {
                            endGame();
                        }
                    }
                };
            }
        }

        // à¹à¸ªà¸”à¸‡à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡
        function showPlayerJoinedNotification(player = null) {
            if (!isHost) return;
            
            // à¸ªà¸£à¹‰à¸²à¸‡à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸šà¸š Toast
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-2">ğŸ‰</span>
                    <div>
                        <p class="font-semibold">à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡!</p>
                        <p class="text-sm">${player ? player.name : 'à¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ'} | à¸£à¸§à¸¡ ${players.length} à¸„à¸™</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // à¹à¸ªà¸”à¸‡à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // à¸‹à¹ˆà¸­à¸™à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸«à¸¥à¸±à¸‡ 3 à¸§à¸´à¸™à¸²à¸—à¸µ
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸à¸¡à¹€à¸£à¸´à¹ˆà¸¡
        function handleGameStart() {
            if (!isHost && currentPlayer && document.getElementById('gameScreen').classList.contains('hidden')) {
                console.log('Starting game for player:', currentPlayer.name);
                startGameForPlayer();
            }
        }

        // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¢à¸¸à¸”à¸à¸²à¸£à¸‹à¸´à¸‡à¸„à¹Œ
        function stopGameSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // à¸ªà¸£à¹‰à¸²à¸‡ floating hearts
        function createFloatingHearts() {
            const container = document.getElementById('heartsContainer');
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = 'ğŸ’•';
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
                container.appendChild(heart);
                
                setTimeout(() => {
                    heart.remove();
                }, 6000);
            }, 800);
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸«à¸¥à¸±à¸
        function showHomeScreen() {
            hideAllScreens();
            document.getElementById('homeScreen').classList.remove('hidden');
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™
        function showHostScreen() {
            hideAllScreens();
            document.getElementById('passwordScreen').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
        }

        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™
        function verifyPassword() {
            const password = document.getElementById('adminPassword').value;
            
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
            if (isMobileDevice()) {
                alert('âš ï¸ à¹‚à¸«à¸¡à¸” Host à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™!\nà¸à¸£à¸¸à¸“à¸²à¹ƒà¸Šà¹‰à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸à¸¡\n\n(Host mode is for computers only!\nPlease use a computer to control the game)');
                return;
            }
            
            if (password === '689') {
                hideAllScreens();
                document.getElementById('hostScreen').classList.remove('hidden');
                isHost = true;
                generateQRCode();
            } else {
                alert('âŒ à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡! à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸¡à¸·à¸­à¸–à¸·à¸­à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        function isMobileDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š User Agent à¹à¸¥à¸°à¸‚à¸™à¸²à¸”à¸«à¸™à¹‰à¸²à¸ˆà¸­
            return mobileRegex.test(userAgent) || 
                   (screenWidth <= 768 && screenHeight <= 1024) ||
                   ('ontouchstart' in window) ||
                   (navigator.maxTouchPoints > 0);
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™
        function showRegisterScreen() {
            // à¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸¡à¸·à¸­à¸–à¸·à¸­à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
            if (!isMobileDevice()) {
                const usePhone = confirm('ğŸ“± à¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸¡à¸·à¸­à¸–à¸·à¸­à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡!\nà¹€à¸à¸·à¹ˆà¸­à¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”\n\nà¸„à¸¥à¸´à¸ OK à¹€à¸à¸·à¹ˆà¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¹ˆà¸­à¸šà¸™à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œ\nà¸«à¸£à¸·à¸­ Cancel à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸¡à¸·à¸­à¸–à¸·à¸­à¹à¸—à¸™\n\n(Recommended to use mobile phone for playing!\nFor the best experience\n\nClick OK to continue on computer\nor Cancel to use mobile instead)');
                
                if (!usePhone) {
                    alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸›à¸´à¸”à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸™à¸µà¹‰à¹ƒà¸™à¸¡à¸·à¸­à¸–à¸·à¸­ à¸«à¸£à¸·à¸­à¸ªà¹à¸à¸™ QR Code à¸ˆà¸²à¸à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œ Host\n\n(Please open this website on mobile phone or scan QR Code from Host computer)');
                    return;
                }
            }
            
            hideAllScreens();
            document.getElementById('registerScreen').classList.remove('hidden');
            isHost = false;
            document.querySelector('#registerScreen button[onclick="showHomeScreen()"]').style.display = 'block';
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ˆà¸²à¸ QR Code
        function showRegisterScreenFromQR() {
            hideAllScreens();
            document.getElementById('registerScreen').classList.remove('hidden');
            isHost = false;
            document.querySelector('#registerScreen button[onclick="showHomeScreen()"]').style.display = 'none';
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸£à¸­à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ˆà¹‰à¸²à¸ à¸²à¸
        function showWaitingScreenAsHost() {
            hideAllScreens();
            document.getElementById('waitingScreen').classList.remove('hidden');
            
            document.getElementById('startGameBtn').style.display = 'block';
            document.getElementById('waitingMessage').style.display = 'none';
            
            if (roomId) {
                document.getElementById('waitingRoomId').textContent = roomId.slice(-8);
            }
            
            console.log('Host viewing waiting screen for room:', roomId);
            
            loadSharedGameData();
            updatePlayersList();
            updateOnlineCount();
            
            startGameSync();
        }

        // à¸‹à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        function hideAllScreens() {
            const screens = ['homeScreen', 'passwordScreen', 'hostScreen', 'registerScreen', 'waitingScreen', 'gameScreen', 'resultScreen', 'hostDashboard'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸² Host Dashboard
        function showHostDashboard() {
            hideAllScreens();
            document.getElementById('hostDashboard').classList.remove('hidden');
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¹‰à¸­à¸‡
            document.getElementById('hostRoomId').textContent = roomId ? roomId.slice(-8) : '-';
            document.getElementById('hostPlayerCount').textContent = players.length;
            
            // à¹€à¸£à¸´à¹ˆà¸¡à¹à¸ªà¸”à¸‡à¸„à¸³à¸–à¸²à¸¡à¹à¸£à¸
            showHostQuestion();
            
            // à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸­à¸±à¸à¹€à¸”à¸— Host Dashboard
            startHostDashboardUpdates();
        }

        // à¹à¸ªà¸”à¸‡à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸™ Host Dashboard
        function showHostQuestion() {
            if (currentQuestion >= questions.length) {
                hostEndGame();
                return;
            }

            const question = questions[currentQuestion];
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¸–à¸²à¸¡
            document.getElementById('hostQuestionNumber').textContent = currentQuestion + 1;
            document.getElementById('hostQuestionText').textContent = question.question;
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸
            for (let i = 0; i < 4; i++) {
                document.getElementById(`hostAnswer${i}`).textContent = question.answers[i];
            }
            
            // à¹à¸ªà¸”à¸‡à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
            document.getElementById('hostCorrectText').textContent = question.answers[question.correct];
            
            // à¹„à¸®à¹„à¸¥à¸—à¹Œà¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸
            const answerDivs = document.querySelectorAll('#hostDashboard .grid > div');
            answerDivs.forEach((div, index) => {
                if (index === question.correct) {
                    div.classList.add('ring-4', 'ring-green-500');
                } else {
                    div.classList.remove('ring-4', 'ring-green-500');
                }
            });
            
            // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸´à¸•à¸´à¸à¸²à¸£à¸•à¸­à¸š
            resetAnswerStats();
            
            // à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸² Host
            startHostTimer();
        }

        // à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²à¸ªà¸³à¸«à¸£à¸±à¸š Host
        function startHostTimer() {
            let hostTimeLeft = 10;
            document.getElementById('hostTimer').textContent = hostTimeLeft;
            
            const hostTimerInterval = setInterval(() => {
                hostTimeLeft--;
                document.getElementById('hostTimer').textContent = hostTimeLeft;
                
                if (hostTimeLeft <= 0) {
                    clearInterval(hostTimerInterval);
                    // à¸«à¸¡à¸”à¹€à¸§à¸¥à¸²à¹à¸¥à¹‰à¸§ à¸£à¸­ 3 à¸§à¸´à¸™à¸²à¸—à¸µà¹à¸¥à¹‰à¸§à¹„à¸›à¸„à¸³à¸–à¸²à¸¡à¸–à¸±à¸”à¹„à¸›
                    setTimeout(() => {
                        currentQuestion++;
                        questionStartTime = Date.now();
                        syncGameData(); // à¸ªà¹ˆà¸‡à¸ªà¸±à¸à¸à¸²à¸“à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹„à¸›à¸„à¸³à¸–à¸²à¸¡à¸–à¸±à¸”à¹„à¸›
                        showHostQuestion();
                    }, 3000);
                }
            }, 1000);
        }

        // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸´à¸•à¸´à¸à¸²à¸£à¸•à¸­à¸š
        function resetAnswerStats() {
            document.getElementById('answerStatsA').textContent = '0';
            document.getElementById('answerStatsB').textContent = '0';
            document.getElementById('answerStatsC').textContent = '0';
            document.getElementById('answerStatsD').textContent = '0';
            document.getElementById('answeredCount').textContent = '0';
            document.getElementById('totalPlayersCount').textContent = players.length;
        }

        // à¸­à¸±à¸à¹€à¸”à¸—à¸ªà¸–à¸´à¸•à¸´à¸à¸²à¸£à¸•à¸­à¸š
        function updateAnswerStats() {
            const currentQuestionIndex = currentQuestion;
            const stats = [0, 0, 0, 0]; // A, B, C, D
            let answeredCount = 0;
            
            players.forEach(player => {
                if (player.answers && player.answers.length > currentQuestionIndex) {
                    const answer = player.answers[currentQuestionIndex];
                    if (answer.selected >= 0 && answer.selected <= 3) {
                        stats[answer.selected]++;
                    }
                    answeredCount++;
                }
            });
            
            document.getElementById('answerStatsA').textContent = stats[0];
            document.getElementById('answerStatsB').textContent = stats[1];
            document.getElementById('answerStatsC').textContent = stats[2];
            document.getElementById('answerStatsD').textContent = stats[3];
            document.getElementById('answeredCount').textContent = answeredCount;
        }

        // à¸­à¸±à¸à¹€à¸”à¸— Scoreboard à¹ƒà¸™ Host Dashboard
        function updateHostScoreboard() {
            const hostLeaderboard = document.getElementById('hostLeaderboard');
            hostLeaderboard.innerHTML = '';
            
            // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸•à¸²à¸¡à¸„à¸°à¹à¸™à¸™
            const sortedPlayers = [...players].sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // à¸–à¹‰à¸²à¸„à¸°à¹à¸™à¸™à¹€à¸—à¹ˆà¸²à¸à¸±à¸™ à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢
                const aAvgTime = a.answers && a.answers.length > 0 ? 
                    a.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / a.answers.length : 0;
                const bAvgTime = b.answers && b.answers.length > 0 ? 
                    b.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / b.answers.length : 0;
                return bAvgTime - aAvgTime;
            });
            
            if (sortedPlayers.length === 0) {
                hostLeaderboard.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ‘¥</div>
                        <p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™à¹€à¸à¸¡</p>
                    </div>
                `;
                return;
            }
            
            sortedPlayers.forEach((player, index) => {
                const character = ensurePlayerCharacter(player);
                const rank = index + 1;
                let rankEmoji = '';
                let bgColor = '';
                
                if (rank === 1) {
                    rankEmoji = 'ğŸ¥‡';
                    bgColor = 'bg-gradient-to-r from-yellow-100 to-yellow-200';
                } else if (rank === 2) {
                    rankEmoji = 'ğŸ¥ˆ';
                    bgColor = 'bg-gradient-to-r from-gray-100 to-gray-200';
                } else if (rank === 3) {
                    rankEmoji = 'ğŸ¥‰';
                    bgColor = 'bg-gradient-to-r from-orange-100 to-orange-200';
                } else {
                    rankEmoji = `${rank}`;
                    bgColor = 'bg-gradient-to-r from-blue-50 to-purple-50';
                }
                
                const answeredQuestions = player.answers ? player.answers.length : 0;
                const progress = Math.round((answeredQuestions / 5) * 100);
                
                const playerRow = document.createElement('div');
                playerRow.className = `${bgColor} p-4 rounded-xl shadow-md flex justify-between items-center mb-2`;
                playerRow.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-xl mr-3 font-bold">${rankEmoji}</span>
                        <div class="text-2xl mr-3">${character}</div>
                        <div>
                            <p class="font-bold text-gray-800">${player.name}</p>
                            ${player.table ? `<p class="text-sm text-gray-600">à¹‚à¸•à¹Šà¸° ${player.table}</p>` : ''}
                            <p class="text-xs text-gray-500">à¸•à¸­à¸šà¹à¸¥à¹‰à¸§: ${answeredQuestions}/5 (${progress}%)</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-purple-600">${player.score}/5</p>
                        <p class="text-sm text-gray-600">à¸„à¸°à¹à¸™à¸™</p>
                    </div>
                `;
                hostLeaderboard.appendChild(playerRow);
            });
        }

        // à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸­à¸±à¸à¹€à¸”à¸— Host Dashboard
        function startHostDashboardUpdates() {
            // à¸­à¸±à¸à¹€à¸”à¸—à¸—à¸¸à¸ 1 à¸§à¸´à¸™à¸²à¸—à¸µ
            const hostUpdateInterval = setInterval(() => {
                if (!document.getElementById('hostDashboard').classList.contains('hidden')) {
                    loadSharedGameData();
                    updateAnswerStats();
                    updateHostScoreboard();
                    document.getElementById('hostPlayerCount').textContent = players.length;
                } else {
                    clearInterval(hostUpdateInterval);
                }
            }, 1000);
        }

        // Host à¸ˆà¸šà¹€à¸à¸¡
        function hostEndGame() {
            gameState = 'finished';
            syncGameData();
            
            // à¸ªà¹ˆà¸‡à¸ªà¸±à¸à¸à¸²à¸“à¸ˆà¸šà¹€à¸à¸¡à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸¸à¸à¸„à¸™
            window.dispatchEvent(new CustomEvent('gameEnded', {
                detail: { roomId: roomId, timestamp: Date.now() }
            }));
            
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('wedding-game-sync');
                channel.postMessage({
                    type: 'gameEnded',
                    roomId: roomId,
                    timestamp: Date.now()
                });
                channel.close();
            }
            
            // Host à¹„à¸›à¸«à¸™à¹‰à¸²à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
            showHostResults();
        }

        // à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ªà¸³à¸«à¸£à¸±à¸š Host
        function showHostResults() {
            hideAllScreens();
            document.getElementById('resultScreen').classList.remove('hidden');
            
            // à¸‹à¹ˆà¸­à¸™à¸ªà¹ˆà¸§à¸™à¸„à¸°à¹à¸™à¸™à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§ (à¹€à¸à¸£à¸²à¸° Host à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¹ˆà¸™)
            document.getElementById('playerScoreSection').style.display = 'none';
            
            // à¹à¸ªà¸”à¸‡à¹€à¸‰à¸à¸²à¸° Leaderboard
            setTimeout(() => {
                loadSharedGameData();
                const activePlayers = players.filter(p => p.answers && p.answers.length > 0);
                activePlayers.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    const aAvgTime = a.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / a.answers.length;
                    const bAvgTime = b.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / b.answers.length;
                    return bAvgTime - aAvgTime;
                });
                
                showLeaderboard(activePlayers);
            }, 1000);
        }

        // à¸ªà¸£à¹‰à¸²à¸‡ QR Code
        function generateQRCode() {
            if (!roomId) {
                createNewGameRoom();
            }
            
            const currentURL = window.location.href.split('?')[0];
            const gameURL = currentURL + '?join=true&room=' + roomId;
            
            document.getElementById('shareLink').value = gameURL;
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¸ªà¸–à¸²à¸™à¸°à¸«à¹‰à¸­à¸‡à¹ƒà¸™ Host Screen
            document.getElementById('hostRoomDisplay').textContent = roomId.slice(-8);
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            console.log('Generating QR Code for room:', roomId, 'URL:', gameURL);
            
            generateQRCodeWithGoogleCharts(gameURL);
            
            // à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸à¹€à¸”à¸—à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™ Host Screen
            updateHostOnlineCount();
            
            // à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸‹à¸´à¸‡à¸„à¹Œà¸ªà¸³à¸«à¸£à¸±à¸š Host
            startGameSync();
        }

        // à¸­à¸±à¸à¹€à¸”à¸—à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™ Host Screen
        function updateHostOnlineCount() {
            const hostOnlineElement = document.getElementById('hostOnlineCount');
            if (hostOnlineElement) {
                hostOnlineElement.textContent = players.length;
            }
        }

        // à¹ƒà¸Šà¹‰ Google Charts API à¸ªà¸£à¹‰à¸²à¸‡ QR Code
        function generateQRCodeWithGoogleCharts(url) {
            const qrContainer = document.getElementById('qrcode');
            
            const qrSize = 200;
            const qrURL = `https://chart.googleapis.com/chart?chs=${qrSize}x${qrSize}&cht=qr&chl=${encodeURIComponent(url)}&choe=UTF-8`;
            
            console.log('Creating QR Code with Google Charts API:', qrURL);
            
            const img = document.createElement('img');
            img.src = qrURL;
            img.alt = 'QR Code à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¹€à¸à¸¡';
            img.className = 'mx-auto border-2 border-purple-300 rounded-lg shadow-lg';
            img.style.width = qrSize + 'px';
            img.style.height = qrSize + 'px';
            
            img.onload = function() {
                console.log('QR Code loaded successfully');
            };
            
            img.onerror = function() {
                console.error('Google Charts QR Code failed, using fallback');
                generateQRCodeFallback(url);
            };
            
            qrContainer.appendChild(img);
        }

        // Fallback method à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡ QR Code
        function generateQRCodeFallback(url) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            const qrSize = 200;
            const alternativeQRURL = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(url)}`;
            
            console.log('Trying alternative QR API:', alternativeQRURL);
            
            const img = document.createElement('img');
            img.src = alternativeQRURL;
            img.alt = 'QR Code à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¹€à¸à¸¡';
            img.className = 'mx-auto border-2 border-purple-300 rounded-lg shadow-lg';
            img.style.width = qrSize + 'px';
            img.style.height = qrSize + 'px';
            
            img.onload = function() {
                console.log('Alternative QR Code loaded successfully');
            };
            
            img.onerror = function() {
                console.error('All QR Code methods failed, showing manual option');
                qrContainer.innerHTML = `
                    <div class="bg-purple-100 border-2 border-purple-300 rounded-lg p-6 text-center shadow-lg" style="width: 200px; height: 200px; margin: 0 auto; display: flex; flex-direction: column; justify-content: center;">
                        <div class="text-4xl mb-3">ğŸ“±</div>
                        <p class="text-sm text-purple-700 font-semibold mb-2">QR Code à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¹„à¸”à¹‰</p>
                        <p class="text-xs text-purple-600">à¸à¸£à¸¸à¸“à¸²à¹ƒà¸Šà¹‰à¸¥à¸´à¸‡à¸à¹Œà¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¹à¸—à¸™</p>
                    </div>
                `;
            };
            
            qrContainer.appendChild(img);
        }

        // à¸„à¸±à¸”à¸¥à¸­à¸à¸¥à¸´à¸‡à¸à¹Œ
        function copyLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(linkInput.value).then(() => {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = 'âœ… à¸„à¸±à¸”à¸¥à¸­à¸à¹à¸¥à¹‰à¸§!';
                button.classList.add('bg-green-500');
                button.classList.remove('bg-blue-500');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-500');
                    button.classList.add('bg-blue-500');
                }, 2000);
            }).catch(() => {
                try {
                    document.execCommand('copy');
                    alert('à¸„à¸±à¸”à¸¥à¸­à¸à¸¥à¸´à¸‡à¸à¹Œà¹à¸¥à¹‰à¸§!');
                } catch (err) {
                    alert('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸„à¸±à¸”à¸¥à¸­à¸à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡');
                }
            });
        }

        // à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¹‰à¹à¸‚à¹‡à¸‡à¹à¸à¸£à¹ˆà¸‡à¸‚à¸¶à¹‰à¸™
        function registerPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const table = document.getElementById('playerTable').value.trim();
            
            if (!name) {
                alert('à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸‚à¸­à¸‡à¸„à¸¸à¸“ (Please enter your name)');
                return;
            }
            
            if (!roomId) {
                alert('à¹„à¸¡à¹ˆà¸à¸šà¸«à¹‰à¸­à¸‡à¹€à¸¥à¹ˆà¸™ à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™ QR Code à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ (Room not found, please scan QR Code again)');
                return;
            }
            
            console.log('Registering player:', name, 'to room:', roomId);
            
            // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸à¹ˆà¸­à¸™à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™
            for (let i = 0; i < 3; i++) {
                loadSharedGameData();
            }
            console.log('Current players in room before registration:', players.length);
            
            if (players.length >= 250) {
                alert('à¸‚à¸­à¸­à¸ à¸±à¸¢ à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹€à¸•à¹‡à¸¡à¹à¸¥à¹‰à¸§ (250 à¸„à¸™) (Sorry, game is full - 250 players)');
                return;
            }
            
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸Šà¸·à¹ˆà¸­à¸‹à¹‰à¸³à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
            const existingPlayer = players.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (existingPlayer) {
                alert('à¸Šà¸·à¹ˆà¸­à¸™à¸µà¹‰à¸¡à¸µà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§à¹ƒà¸™à¸«à¹‰à¸­à¸‡à¸™à¸µà¹‰ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸Šà¹‰à¸Šà¸·à¹ˆà¸­à¸­à¸·à¹ˆà¸™ (This name is already taken in this room, please use another name)');
                return;
            }
            
            // à¸ªà¸£à¹‰à¸²à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆ
            currentPlayer = {
                id: 'player-' + Date.now() + '-' + Math.floor(Math.random() * 10000),
                name: name,
                table: table || '',
                character: getUniqueAnimalCharacter(),
                score: 0,
                answers: [],
                joinedAt: Date.now(),
                roomId: roomId,
                registrationTimestamp: Date.now()
            };
            
            console.log('Created new player:', currentPlayer);
            
            // à¹€à¸à¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™à¸£à¸²à¸¢à¸à¸²à¸£
            players.push(currentPlayer);
            
            // à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ localStorage
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            localStorage.setItem('playerRoomId', roomId);
            
            // à¸‹à¸´à¸‡à¸„à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸¡à¸£à¸§à¸¡à¸—à¸±à¸™à¸—à¸µà¸«à¸¥à¸²à¸¢à¸„à¸£à¸±à¹‰à¸‡
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    syncGameData();
                    console.log('Sync attempt', i + 1, 'for player registration');
                }, i * 200);
            }
            
            // à¸ªà¹ˆà¸‡à¸ªà¸±à¸à¸à¸²à¸“à¸«à¸¥à¸²à¸¢à¹à¸šà¸šà¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('playerJoined', {
                    detail: { player: currentPlayer, roomId: roomId, timestamp: Date.now() }
                }));
                
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'room-' + roomId,
                    newValue: JSON.stringify({
                        roomId: roomId,
                        players: players,
                        timestamp: Date.now()
                    })
                }));
                
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('wedding-game-sync');
                    channel.postMessage({
                        type: 'playerJoined',
                        roomId: roomId,
                        player: currentPlayer,
                        totalPlayers: players.length,
                        timestamp: Date.now()
                    });
                    channel.close();
                }
                
                console.log('All sync signals sent for player registration');
            }, 100);
            
            console.log('Player registered successfully to room:', roomId, 'Total players:', players.length);
            
            showWaitingScreen();
        }

        // à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸£à¸­
        function showWaitingScreen() {
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('waitingScreen').classList.remove('hidden');
            
            document.getElementById('startGameBtn').style.display = 'none';
            document.getElementById('waitingMessage').style.display = 'block';
            
            if (roomId) {
                document.getElementById('waitingRoomId').textContent = roomId.slice(-8);
            }
            
            if (currentPlayer) {
                ensurePlayerCharacter(currentPlayer);
                document.getElementById('welcomeName').textContent = currentPlayer.name;
                document.getElementById('welcomeTable').textContent = currentPlayer.table ? `à¹‚à¸•à¹Šà¸° ${currentPlayer.table}` : '';
                document.getElementById('playerCharacter').textContent = currentPlayer.character;
                
                localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            }
            
            updatePlayersList();
            updateOnlineCount();
            
            startGameSync();
        }

        // à¸­à¸±à¸à¹€à¸”à¸—à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            
            if (!playersList) {
                console.log('Players list element not found');
                return;
            }
            
            console.log('Updating players list with', players.length, 'players');
            playersList.innerHTML = '';
            
            if (players.length === 0) {
                playersList.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ‘¥</div>
                        <p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡</p>
                        <p class="text-sm">(No players joined yet)</p>
                    </div>
                `;
                return;
            }
            
            players.forEach((player, index) => {
                const character = ensurePlayerCharacter(player);
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card bg-gradient-to-r from-pink-100 to-purple-100 p-4 rounded-xl shadow-md';
                playerCard.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">${character}</div>
                        <p class="font-semibold text-gray-800">${player.name}</p>
                        ${player.table ? `<p class="text-sm text-gray-600">à¹‚à¸•à¹Šà¸° ${player.table}</p>` : ''}
                        <p class="text-xs text-gray-400 mt-1">ID: ${player.id.toString().slice(-6)}</p>
                    </div>
                `;
                playersList.appendChild(playerCard);
            });
            
            console.log('Players list updated successfully');
        }

        // à¸­à¸±à¸à¹€à¸”à¸—à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
        function updateOnlineCount() {
            const count = players.length;
            const onlineCountElements = ['onlineCount', 'onlineCountRegister', 'totalPlayers', 'gamePlayerCount', 'hostOnlineCount'];
            
            onlineCountElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = count;
                }
            });
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¹ƒà¸™ Host Screen à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡
            updateHostOnlineCount();
        }

        // à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (à¸ªà¸³à¸«à¸£à¸±à¸š Admin à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™) - Host à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
        function startGame() {
            if (!isHost) {
                alert('à¹€à¸‰à¸à¸²à¸° Admin à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡à¹„à¸”à¹‰ (Only Admin can start the game)');
                return;
            }
            
            if (players.length === 0) {
                alert('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡ (No players joined yet)');
                return;
            }
            
            console.log('Admin starting game with', players.length, 'players');
            
            // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¹€à¸à¸¡
            gameStarted = true;
            gameState = 'playing';
            currentQuestion = 0;
            questionStartTime = Date.now();
            timeLeft = 10;
            
            // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸„à¸°à¹à¸™à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸¸à¸à¸„à¸™
            players.forEach(player => {
                player.score = 0;
                player.answers = [];
                player.currentQuestion = 0;
            });
            
            // à¸‹à¸´à¸‡à¸„à¹Œà¸ªà¸–à¸²à¸™à¸°à¹€à¸à¸¡à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸¸à¸à¸„à¸™
            syncGameData();
            
            // à¸ªà¹ˆà¸‡à¸ªà¸±à¸à¸à¸²à¸“à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡
            window.dispatchEvent(new CustomEvent('gameStarted', {
                detail: { 
                    roomId: roomId, 
                    players: players.length,
                    currentQuestion: currentQuestion,
                    questionStartTime: questionStartTime,
                    timestamp: Date.now()
                }
            }));
            
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('wedding-game-sync');
                channel.postMessage({
                    type: 'gameStarted',
                    roomId: roomId,
                    players: players,
                    currentQuestion: currentQuestion,
                    questionStartTime: questionStartTime,
                    gameStarted: true,
                    timestamp: Date.now()
                });
                channel.close();
            }
            
            console.log('Game start signals sent to all players');
            
            // Host à¹„à¸›à¸«à¸™à¹‰à¸² Host Dashboard à¹à¸—à¸™à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡
            showHostDashboard();
        }

        // à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
        function startGameForPlayer() {
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            if (currentPlayer) {
                ensurePlayerCharacter(currentPlayer);
                document.getElementById('gamePlayerCharacter').textContent = currentPlayer.character;
                localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            }
            
            score = 0;
            showQuestion();
        }

        // à¹à¸ªà¸”à¸‡à¸„à¸³à¸–à¸²à¸¡ - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¹‰à¸—à¸³à¸‡à¸²à¸™à¸•à¸²à¸¡à¹€à¸§à¸¥à¸² 10 à¸§à¸´à¸™à¸²à¸—à¸µà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
        function showQuestion() {
            if (currentQuestion >= questions.length) {
                endGame();
                return;
            }

            gameActive = true;
            timeLeft = 10; // à¸„à¸‡à¸—à¸µà¹ˆ 10 à¸§à¸´à¸™à¸²à¸—à¸µ
            questionStartTime = Date.now();
            
            // à¸­à¸±à¸à¹€à¸”à¸— UI
            document.getElementById('questionNumber').textContent = currentQuestion + 1;
            document.getElementById('score').textContent = score;
            document.getElementById('questionText').textContent = questions[currentQuestion].question;
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸
            for (let i = 0; i < 4; i++) {
                document.getElementById(`answerText${i}`).textContent = questions[currentQuestion].answers[i];
                document.getElementById(`answer${i}`).disabled = false;
                document.getElementById(`answer${i}`).classList.remove('correct-answer', 'wrong-answer');
            }

            // à¸­à¸±à¸à¹€à¸”à¸— Progress Bar
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // à¸‹à¸´à¸‡à¸„à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ (à¸ªà¸³à¸«à¸£à¸±à¸š Host)
            if (isHost) {
                syncGameData();
            }

            // à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²
            startTimer();
        }

        // à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸² - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¹‰à¸—à¸³à¸‡à¸²à¸™à¸•à¸£à¸‡à¹€à¸§à¸¥à¸² 10 à¸§à¸´à¸™à¸²à¸—à¸µ
        function startTimer() {
            // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ Host à¹ƒà¸«à¹‰à¸‹à¸´à¸‡à¸„à¹Œà¹€à¸§à¸¥à¸²à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹à¸Šà¸£à¹Œ
            if (!isHost && questionStartTime) {
                const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                timeLeft = Math.max(0, 10 - elapsed);
            }
            
            document.getElementById('timer').textContent = timeLeft;
            
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    if (gameActive) {
                        selectAnswer(-1); // à¸«à¸¡à¸”à¹€à¸§à¸¥à¸² - à¹„à¸”à¹‰ 0 à¸„à¸°à¹à¸™à¸™
                    }
                }
            }, 1000);
        }

        // à¹€à¸¥à¸·à¸­à¸à¸„à¸³à¸•à¸­à¸š - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¹‰à¸—à¸³à¸‡à¸²à¸™à¸•à¸²à¸¡à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”
        function selectAnswer(selectedIndex) {
            if (!gameActive) return;
            
            gameActive = false;
            clearInterval(timer);
            
            const correctIndex = questions[currentQuestion].correct;
            let isCorrect = false;
            
            // à¹à¸ªà¸”à¸‡à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸
            document.getElementById(`answer${correctIndex}`).classList.add('correct-answer');
            
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸³à¸•à¸­à¸š
            if (selectedIndex === correctIndex) {
                score++;
                currentPlayer.score++;
                isCorrect = true;
                document.getElementById('score').textContent = score;
            } else if (selectedIndex >= 0) {
                // à¸•à¸­à¸šà¸œà¸´à¸”
                document.getElementById(`answer${selectedIndex}`).classList.add('wrong-answer');
            }
            // à¸–à¹‰à¸² selectedIndex === -1 à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡à¸«à¸¡à¸”à¹€à¸§à¸¥à¸² (à¹„à¸”à¹‰ 0 à¸„à¸°à¹à¸™à¸™)

            // à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸³à¸•à¸­à¸š
            currentPlayer.answers.push({
                question: currentQuestion,
                selected: selectedIndex,
                correct: correctIndex,
                isCorrect: isCorrect,
                timeLeft: timeLeft,
                answeredAt: Date.now()
            });

            // à¸›à¸´à¸”à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸›à¸¸à¹ˆà¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
            for (let i = 0; i < 4; i++) {
                document.getElementById(`answer${i}`).disabled = true;
            }

            // à¸­à¸±à¸à¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™à¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸§à¸¡
            const playerIndex = players.findIndex(p => p.id === currentPlayer.id);
            if (playerIndex !== -1) {
                players[playerIndex] = { ...currentPlayer };
            }

            // à¸­à¸±à¸à¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ localStorage
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            // à¸‹à¸´à¸‡à¸„à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸°à¹à¸™à¸™
            syncGameData();

            // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸•à¸²à¸¡à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
            let resultMessage = '';
            if (selectedIndex === -1) {
                resultMessage = 'â° à¸«à¸¡à¸”à¹€à¸§à¸¥à¸²! (Time\'s up!)';
            } else if (isCorrect) {
                resultMessage = 'ğŸ‰ à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡! (Correct!)';
            } else {
                resultMessage = 'âŒ à¸œà¸´à¸”! (Wrong!)';
            }
            
            // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§
            const questionText = document.getElementById('questionText');
            const originalText = questionText.textContent;
            questionText.innerHTML = `<div class="text-2xl mb-2">${resultMessage}</div><div class="text-lg">${originalText}</div>`;

            // à¹„à¸›à¸„à¸³à¸–à¸²à¸¡à¸–à¸±à¸”à¹„à¸›à¸«à¸¥à¸±à¸‡ 3 à¸§à¸´à¸™à¸²à¸—à¸µ
            setTimeout(() => {
                currentQuestion++;
                
                // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ Host à¹ƒà¸«à¹‰à¸­à¸±à¸à¹€à¸”à¸—à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ
                if (isHost) {
                    questionStartTime = Date.now();
                    syncGameData();
                }
                
                showQuestion();
            }, 3000);
        }

        // à¸ˆà¸šà¹€à¸à¸¡ - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¹‰à¹à¸ªà¸”à¸‡à¸œà¸¥à¸­à¸±à¸™à¸”à¸±à¸š Top 10
        function endGame() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            
            gameState = 'finished';
            
            // à¹à¸ªà¸”à¸‡à¸ªà¹ˆà¸§à¸™à¸„à¸°à¹à¸™à¸™à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§ (à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™)
            document.getElementById('playerScoreSection').style.display = 'block';
            
            // à¸­à¸±à¸à¹€à¸”à¸—à¸„à¸°à¹à¸™à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™ array
            const playerIndex = players.findIndex(p => p.id === currentPlayer.id);
            if (playerIndex !== -1) {
                players[playerIndex] = { ...currentPlayer };
            }
            
            // à¸‹à¸´à¸‡à¸„à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸¡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢
            syncGameData();
            
            // à¸£à¸­à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‹à¸´à¸‡à¸„à¹Œà¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¹à¸ªà¸”à¸‡à¸œà¸¥
            setTimeout(() => {
                // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¹„à¸”à¹‰à¸„à¸°à¹à¸™à¸™à¸—à¸¸à¸à¸„à¸™
                loadSharedGameData();
                
                // à¸à¸£à¸­à¸‡à¹€à¸‰à¸à¸²à¸°à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸°à¹à¸™à¸™ (à¹€à¸¥à¹ˆà¸™à¸ˆà¸£à¸´à¸‡)
                const activePlayers = players.filter(p => p.answers && p.answers.length > 0);
                
                // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸•à¸²à¸¡à¸„à¸°à¹à¸™à¸™ (à¸ªà¸¹à¸‡à¸ªà¸¸à¸”à¸à¹ˆà¸­à¸™)
                activePlayers.sort((a, b) => {
                    // à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸„à¸°à¹à¸™à¸™à¸à¹ˆà¸­à¸™
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    // à¸–à¹‰à¸²à¸„à¸°à¹à¸™à¸™à¹€à¸—à¹ˆà¸²à¸à¸±à¸™ à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸•à¸­à¸šà¹€à¸£à¹‡à¸§à¸à¸§à¹ˆà¸²
                    const aAvgTime = a.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / a.answers.length;
                    const bAvgTime = b.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / b.answers.length;
                    return bAvgTime - aAvgTime; // à¹€à¸§à¸¥à¸²à¹€à¸«à¸¥à¸·à¸­à¸¡à¸²à¸à¸à¸§à¹ˆà¸² = à¸•à¸­à¸šà¹€à¸£à¹‡à¸§à¸à¸§à¹ˆà¸²
                });
                
                // à¸«à¸²à¸­à¸±à¸™à¸”à¸±à¸šà¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
                const playerRank = activePlayers.findIndex(p => p.id === currentPlayer.id) + 1;
                
                document.getElementById('finalScore').textContent = score;
                
                if (playerRank > 0) {
                    document.getElementById('playerRank').textContent = `ğŸ… à¸­à¸±à¸™à¸”à¸±à¸šà¸—à¸µà¹ˆ ${playerRank} à¸ˆà¸²à¸ ${activePlayers.length} à¸„à¸™ (Rank ${playerRank} of ${activePlayers.length} players)`;
                } else {
                    document.getElementById('playerRank').textContent = `à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™ (No competition data found)`;
                }
                
                // à¹à¸ªà¸”à¸‡à¸­à¸±à¸™à¸”à¸±à¸š Top 10
                showLeaderboard(activePlayers);
                
                // à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ emoji à¸•à¸²à¸¡à¸­à¸±à¸™à¸”à¸±à¸š
                let emoji = "ğŸ‰";
                if (playerRank === 1) emoji = "ğŸ†";
                else if (playerRank === 2) emoji = "ğŸ¥ˆ";
                else if (playerRank === 3) emoji = "ğŸ¥‰";
                else if (playerRank <= 10) emoji = "â­";
                
                document.getElementById('resultEmoji').textContent = emoji;
                
                console.log('Game ended. Final rankings:', activePlayers.map(p => ({ name: p.name, score: p.score })));
            }, 1000);
        }

        // à¹à¸ªà¸”à¸‡à¸­à¸±à¸™à¸”à¸±à¸šà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ Top 10
        function showLeaderboard(activePlayers = null) {
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '';
            
            // à¹ƒà¸Šà¹‰ activePlayers à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸² à¸«à¸£à¸·à¸­à¸à¸£à¸­à¸‡à¸ˆà¸²à¸ players à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
            const playersToShow = activePlayers || players.filter(p => p.answers && p.answers.length > 0);
            
            // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆ
            playersToShow.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // à¸–à¹‰à¸²à¸„à¸°à¹à¸™à¸™à¹€à¸—à¹ˆà¸²à¸à¸±à¸™ à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­ (à¸•à¸­à¸šà¹€à¸£à¹‡à¸§à¸à¸§à¹ˆà¸²)
                const aAvgTime = a.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / a.answers.length;
                const bAvgTime = b.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / b.answers.length;
                return bAvgTime - aAvgTime;
            });
            
            const top10 = playersToShow.slice(0, 10);
            
            if (top10.length === 0) {
                leaderboard.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ†</div>
                        <p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸µà¹ˆà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™</p>
                        <p class="text-sm">(No players have completed the game yet)</p>
                    </div>
                `;
                return;
            }
            
            top10.forEach((player, index) => {
                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸—à¸µà¹ˆà¸«à¸²à¸¢à¹„à¸›
                const character = ensurePlayerCharacter(player);
                
                const rank = index + 1;
                let rankEmoji = '';
                let bgColor = '';
                
                if (rank === 1) {
                    rankEmoji = 'ğŸ¥‡';
                    bgColor = 'bg-gradient-to-r from-yellow-200 to-yellow-300 border-2 border-yellow-400';
                } else if (rank === 2) {
                    rankEmoji = 'ğŸ¥ˆ';
                    bgColor = 'bg-gradient-to-r from-gray-200 to-gray-300 border-2 border-gray-400';
                } else if (rank === 3) {
                    rankEmoji = 'ğŸ¥‰';
                    bgColor = 'bg-gradient-to-r from-orange-200 to-orange-300 border-2 border-orange-400';
                } else {
                    rankEmoji = `${rank}`;
                    bgColor = 'bg-gradient-to-r from-blue-100 to-purple-100';
                }
                
                const isCurrentPlayer = currentPlayer && player.id === currentPlayer.id;
                
                // à¸„à¸³à¸™à¸§à¸“à¹€à¸§à¸¥à¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸•à¸­à¸š
                const avgTimeLeft = player.answers.reduce((sum, ans) => sum + (ans.timeLeft || 0), 0) / player.answers.length;
                const avgTimeUsed = 10 - avgTimeLeft;
                
                const playerRow = document.createElement('div');
                playerRow.className = `${bgColor} p-4 rounded-xl shadow-md flex justify-between items-center ${isCurrentPlayer ? 'ring-4 ring-pink-500 ring-opacity-50' : ''} mb-2`;
                playerRow.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4 font-bold">${rankEmoji}</span>
                        <div class="text-3xl mr-3">${character}</div>
                        <div>
                            <p class="font-bold text-gray-800">${player.name} ${isCurrentPlayer ? '(à¸„à¸¸à¸“)' : ''}</p>
                            ${player.table ? `<p class="text-sm text-gray-600">à¹‚à¸•à¹Šà¸° ${player.table}</p>` : ''}
                            <p class="text-xs text-gray-500">à¹€à¸§à¸¥à¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢: ${avgTimeUsed.toFixed(1)}s</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-purple-600">${player.score}/5</p>
                        <p class="text-sm text-gray-600">à¸„à¸°à¹à¸™à¸™</p>
                        <p class="text-xs text-gray-500">${Math.round((player.score/5)*100)}%</p>
                    </div>
                `;
                leaderboard.appendChild(playerRow);
            });
            
            // à¹à¸ªà¸”à¸‡à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
            if (playersToShow.length > 10) {
                const morePlayersDiv = document.createElement('div');
                morePlayersDiv.className = 'text-center text-gray-500 mt-4 p-3 bg-gray-100 rounded-xl';
                morePlayersDiv.innerHTML = `
                    <p class="text-sm">à¹à¸¥à¸°à¸­à¸µà¸ ${playersToShow.length - 10} à¸„à¸™ (And ${playersToShow.length - 10} more players)</p>
                `;
                leaderboard.appendChild(morePlayersDiv);
            }
            
            console.log('Leaderboard updated with', top10.length, 'players');
        }

        // à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡à¹ƒà¸«à¸¡à¹ˆ
        function restartGame() {
            stopGameSync();
            
            players = [];
            currentPlayer = null;
            score = 0;
            currentQuestion = 0;
            gameStarted = false;
            gameActive = false;
            isHost = false;
            gameState = 'waiting';
            
            localStorage.removeItem('currentPlayer');
            localStorage.removeItem('playerRoomId');
            
            if (timer) {
                clearInterval(timer);
            }
            
            document.getElementById('resultScreen').classList.add('hidden');
            showHomeScreen();
        }

        // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
        function loadGameData() {
            loadSharedGameData();
            
            const savedCurrentPlayer = localStorage.getItem('currentPlayer');
            const savedPlayerRoomId = localStorage.getItem('playerRoomId');
            
            if (savedCurrentPlayer && savedPlayerRoomId) {
                currentPlayer = JSON.parse(savedCurrentPlayer);
                
                if (currentPlayer.roomId === savedPlayerRoomId) {
                    roomId = savedPlayerRoomId;
                    
                    loadSharedGameData();
                    
                    ensurePlayerCharacter(currentPlayer);
                    localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
                    
                    const playerExists = players.find(p => p.id === currentPlayer.id);
                    if (!playerExists) {
                        players.push(currentPlayer);
                        syncGameData();
                    }
                    
                    console.log('Restored player session for room:', roomId);
                    showWaitingScreen();
                } else {
                    localStorage.removeItem('currentPlayer');
                    localStorage.removeItem('playerRoomId');
                    currentPlayer = null;
                }
            }
            
            updateOnlineCount();
        }

        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š URL parameters
        function checkURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinParam = urlParams.get('join');
            const roomParam = urlParams.get('room');
            
            if (joinParam === 'true' && roomParam) {
                roomId = roomParam;
                console.log('Joining room from QR Code:', roomId);
                
                loadSharedGameData();
                
                showRegisterScreenFromQR();
                
                updateRoomInfo();
            } else if (joinParam === 'true') {
                alert('à¸¥à¸´à¸‡à¸à¹Œà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸«à¸£à¸·à¸­à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸à¹à¸¥à¹‰à¸§ à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™ QR Code à¹ƒà¸«à¸¡à¹ˆ (This link is invalid or expired, please scan a new QR Code)');
                showHomeScreen();
            } else {
                showHomeScreen();
            }
        }

        // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¹‰à¸­à¸‡à¹ƒà¸™à¸«à¸™à¹‰à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™
        function updateRoomInfo() {
            const registerScreen = document.getElementById('registerScreen');
            if (registerScreen && roomId) {
                let roomInfoElement = document.getElementById('roomInfo');
                if (!roomInfoElement) {
                    roomInfoElement = document.createElement('div');
                    roomInfoElement.id = 'roomInfo';
                    roomInfoElement.className = 'mb-4 p-3 bg-purple-100 rounded-xl border border-purple-300';
                    
                    const inputContainer = registerScreen.querySelector('.mb-6');
                    inputContainer.parentNode.insertBefore(roomInfoElement, inputContainer);
                }
                
                roomInfoElement.innerHTML = `
                    <div class="text-center">
                        <p class="text-sm font-semibold text-purple-700">ğŸ  à¸«à¹‰à¸­à¸‡à¹€à¸¥à¹ˆà¸™ (Game Room)</p>
                        <p class="text-xs text-purple-600">ID: ${roomId.slice(-8)}</p>
                        <p class="text-xs text-purple-600">à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™à¸«à¹‰à¸­à¸‡: ${players.length} à¸„à¸™</p>
                    </div>
                `;
            }
        }

        // à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¸ˆà¸²à¸à¸«à¹‰à¸­à¸‡à¸£à¸­
        function goBackFromWaiting() {
            if (isHost) {
                showHostScreen();
            } else {
                isHost = false;
                showRegisterScreen();
                if (currentPlayer) {
                    document.getElementById('playerName').value = currentPlayer.name;
                    document.getElementById('playerTable').value = currentPlayer.table;
                }
            }
        }

        // à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸µà¸šà¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸°
        function debugGameState() {
            console.log('=== GAME DEBUG INFO ===');
            console.log('Room ID:', roomId);
            console.log('Is Host:', isHost);
            console.log('Players count:', players.length);
            console.log('Players:', players.map(p => ({ id: p.id, name: p.name, character: p.character })));
            console.log('Game State:', gameState);
            console.log('Game Started:', gameStarted);
            console.log('Current Player:', currentPlayer);
            
            const keys = ['room-' + roomId, 'currentGameData', 'globalGameData', 'allRoomsData', 'currentPlayer', 'activeRoomId'];
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        console.log(key + ':', parsed);
                    } catch (e) {
                        console.log(key + ' (raw):', data);
                    }
                }
            });
            console.log('======================');
        }

        // à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹€à¸à¸¡
        window.onload = function() {
            console.log('Game initializing...');
            createFloatingHearts();
            loadGameData();
            checkURLParameters();
            
            loadSharedGameData();
            updateOnlineCount();
            
            // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸µà¸šà¸±à¸à¸—à¸¸à¸ 10 à¸§à¸´à¸™à¸²à¸—à¸µ
            setInterval(() => {
                if (isHost) {
                    console.log('Host sync check - Players:', players.length, 'Room:', roomId);
                }
            }, 10000);
        };

        // à¸­à¸±à¸à¹€à¸”à¸—à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸—à¸¸à¸ 5 à¸§à¸´à¸™à¸²à¸—à¸µ
        setInterval(() => {
            if (roomId) {
                loadSharedGameData();
                updateOnlineCount();
            }
        }, 5000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975a3f9bd361d335',t:'MTc1NjI4Mzg2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
